import { UserType } from '../constants/auth.constant.js';
import {
  ForbiddenException,
  NotFoundException,
} from '../err/http.exception.js';
import { AssistantRepository } from '../repos/assistant.repo.js';
import { ParentChildLinkRepository } from '../repos/parent-child-link.repo.js';
import type { Enrollment } from '../generated/prisma/client.js';

export class PermissionService {
  constructor(
    private readonly assistantRepository: AssistantRepository,
    private readonly parentChildLinkRepository: ParentChildLinkRepository,
  ) {}

  /** 강사/조교 쓰기 권한 체크 */
  async validateInstructorAccess(
    instructorId: string,
    userType: UserType,
    profileId: string,
  ) {
    const effectiveId = await this.getEffectiveInstructorId(
      userType,
      profileId,
    );

    if (effectiveId !== instructorId) {
      throw new ForbiddenException('해당 권한이 없습니다.');
    }
  }

  /** 실제 권한을 가진 강사 ID 추출 */
  async getEffectiveInstructorId(
    userType: UserType,
    profileId: string,
  ): Promise<string> {
    if (userType === UserType.INSTRUCTOR) {
      return profileId;
    }

    if (userType === UserType.ASSISTANT) {
      const assistant = await this.assistantRepository.findById(profileId);
      if (!assistant) {
        throw new ForbiddenException('조교 정보를 찾을 수 없습니다.');
      }
      return assistant.instructorId;
    }

    throw new ForbiddenException('강사 또는 조교만 접근 가능합니다.');
  }

  /** 학생 권한 체크 */
  async validateStudentAccess(profileId: string, studentId: string) {
    if (profileId !== studentId) {
      throw new ForbiddenException('본인의 정보만 조회할 수 있습니다.');
    }
  }

  /** 자녀 접근 권한 검증 */
  async validateChildAccess(
    userType: UserType,
    profileId: string,
    childLinkId: string,
  ) {
    if (userType !== UserType.PARENT) {
      throw new ForbiddenException('접근 권한이 없습니다.');
    }

    const childLink =
      await this.parentChildLinkRepository.findById(childLinkId);
    if (!childLink) {
      throw new NotFoundException('자녀 정보를 찾을 수 없습니다.');
    }

    if (childLink.appParentId !== profileId) {
      throw new ForbiddenException('본인의 자녀만 조회할 수 있습니다.');
    }

    return childLink;
  }

  /** 수강 정보 조회 권한 체크 (강사/조교/학생/학부모 통합) */
  async validateEnrollmentReadAccess(
    enrollment: Enrollment,
    userType: UserType,
    profileId: string,
  ) {
    if (userType === UserType.INSTRUCTOR || userType === UserType.ASSISTANT) {
      await this.validateInstructorAccess(
        enrollment.instructorId,
        userType,
        profileId,
      );
      return;
    }

    if (userType === UserType.STUDENT) {
      await this.validateStudentAccess(profileId, enrollment.appStudentId!);
      return;
    }

    if (userType === UserType.PARENT) {
      if (!enrollment.appParentLinkId) {
        throw new ForbiddenException('연결된 자녀 정보가 없습니다.');
      }
      await this.validateChildAccess(
        userType,
        profileId,
        enrollment.appParentLinkId,
      );
      return;
    }

    throw new ForbiddenException('접근 권한이 없습니다.');
  }
}
